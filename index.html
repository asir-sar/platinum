<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moving Company Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .icon-card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid rgb(229, 231, 235);
            border-radius: 0.75rem;
            /* rounded-xl */
        }

        .icon-card.selected {
            background-color: rgba(65, 131, 215, 0.1);
            /* A light blue to match the brand */
            box-shadow: 0 0 0 4px #297be2;
            /* A strong blue ring */
        }

        .icon-card-small {
            min-width: unset;
        }

        /* Custom styles to match the Platinum-Umz√ºge site */
        h2,
        h3,
        h4,
        .form-label {
            color: #444;
            /* Dark gray for text */
        }

        .btn-primary {
            background-color: #22a9e3;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            /* full rounded */
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #1a8fbe;
        }

        .btn-secondary {
            background-color: #eee;
            color: #444;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            /* full rounded */
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-secondary:hover {
            background-color: #ddd;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        select,
        textarea {
            border: 1px solid #ccc;
            border-radius: 0;
            padding: 0.75rem;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, .075);
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen py-10">
    <div class="bg-white p-8 sm:p-10 w-full max-w-2xl mx-4 transition-all duration-300">
        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between items-center text-sm font-semibold text-gray-600 mb-2">
                <span id="step-count">Step 1 of 5</span>
                <span id="step-name">Location</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500 ease-in-out"
                    style="width: 20%;"></div>
            </div>
        </div>

        <!-- Validation message box -->
        <div id="validation-message" class="hidden p-4 mb-6 rounded-lg bg-red-100 text-red-700 font-medium">
            Please fill in all the required fields.
        </div>

        <!--
            The form no longer has an "action" attribute.
            The submission is handled securely by the JavaScript "fetch" function.
        -->
        <form id="moving-form">
            <!-- Honeypot field for spam prevention -->
            <input type="text" name="_honeypot" style="display:none !important;" tabindex="-1" autocomplete="off">

            <!-- Step 1: Assignment Location -->
            <div id="step-1" class="step-content active">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-800">Where is your assignment located?</h2>
                <p class="text-gray-600 mb-6">Please provide the postcode of your order.</p>
                <input type="text" id="origin-postcode" name="origin_postcode" placeholder="Postcode"
                    class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </div>

            <!-- Step 2: What to transport & other details -->
            <div id="step-2" class="step-content">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-800">What do you want to transport?</h2>
                <p class="text-gray-600 mb-6">Please select all the options you need.</p>
                <div id="item-selection" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
                    <div class="icon-card flex flex-col items-center p-4 rounded-xl hover:bg-gray-50" data-value="TV">
                        <span class="text-3xl mb-2">üì∫</span>
                        <span class="text-sm font-medium text-gray-700">TV</span>
                    </div>
                    <div class="icon-card flex flex-col items-center p-4 rounded-xl hover:bg-gray-50" data-value="Bed">
                        <span class="text-3xl mb-2">üõèÔ∏è</span>
                        <span class="text-sm font-medium text-gray-700">Bed</span>
                    </div>
                    <div class="icon-card flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Wardrobe">
                        <span class="text-3xl mb-2">üëî</span>
                        <span class="text-sm font-medium text-gray-700">Wardrobe</span>
                    </div>
                    <div class="icon-card flex flex-col items-center p-4 rounded-xl hover:bg-gray-50" data-value="Sofa">
                        <span class="text-3xl mb-2">üõãÔ∏è</span>
                        <span class="text-sm font-medium text-gray-700">Sofa</span>
                    </div>
                    <div class="icon-card flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Table">
                        <span class="text-3xl mb-2">üçΩÔ∏è</span>
                        <span class="text-sm font-medium text-gray-700">Table</span>
                    </div>
                    <div class="icon-card flex flex-col items-center p-4 rounded-xl hover:bg-gray-50" data-value="Box">
                        <span class="text-3xl mb-2">üì¶</span>
                        <span class="text-sm font-medium text-gray-700">Box</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="boxes" class="block text-sm font-medium text-gray-700 mb-2">How many moving boxes?
                            (optional)</label>
                        <input type="number" id="boxes" name="boxes_count" placeholder="Number of boxes"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </div>
                    <div>
                        <label for="living-space" class="block text-sm font-medium text-gray-700 mb-2">Approximate
                            living space (m¬≤)? (optional)</label>
                        <input type="number" id="living-space" name="living_space" placeholder="Size in m¬≤"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </div>
                </div>

                <h3 class="text-lg font-semibold mb-3 text-gray-800">Who will take over the packing?</h3>
                <div id="packing-selection" class="flex flex-wrap gap-4 mb-8">
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Self">
                        <span class="text-3xl mb-2">üôã</span>
                        <span class="text-sm font-medium text-gray-700 text-center">Packing yourself</span>
                    </div>
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Company">
                        <span class="text-3xl mb-2">üì¶üöö</span>
                        <span class="text-sm font-medium text-gray-700 text-center">Moving Company</span>
                    </div>
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Consultation">
                        <span class="text-3xl mb-2">ü§ù</span>
                        <span class="text-sm font-medium text-gray-700 text-center">After consultation</span>
                    </div>
                </div>

                <h3 class="text-lg font-semibold mb-3 text-gray-800">Do you need additional services? (optional)</h3>
                <div id="services-selection" class="flex flex-wrap gap-4">
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Assembly">
                        <span class="text-3xl mb-2">üõ†Ô∏è</span>
                        <span class="text-sm font-medium text-gray-700 text-center">Assembly & Removal</span>
                    </div>
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Packaging">
                        <span class="text-3xl mb-2">üì¶</span>
                        <span class="text-sm font-medium text-gray-700 text-center">Packaging Material</span>
                    </div>
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Storage">
                        <span class="text-3xl mb-2">üè†</span>
                        <span class="text-sm font-medium text-gray-700 text-center">Storage</span>
                    </div>
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Other">
                        <span class="text-3xl mb-2">‚ÑπÔ∏è</span>
                        <span class="text-sm font-medium text-gray-700 text-center">Other</span>
                    </div>
                </div>
            </div>

            <!-- Step 3: Origin and destination details -->
            <div id="step-3" class="step-content">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-800">Move-out and Move-in Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label for="origin-floor" class="block text-sm font-medium text-gray-700 mb-2">Move-out
                            floor</label>
                        <select id="origin-floor" name="origin_floor"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                            <option value="">Select Floor</option>
                            <option value="1">Floor 1</option>
                            <option value="2">Floor 2</option>
                            <option value="3">Floor 3</option>
                            <option value="4">Floor 4</option>
                            <option value="5+">Floor 5+</option>
                        </select>
                    </div>
                    <div>
                        <label for="origin-elevator" class="block text-sm font-medium text-gray-700 mb-2">Elevator at
                            origin?</label>
                        <select id="origin-elevator" name="origin_elevator"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                            <option value="">Select Option</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    <div>
                        <label for="origin-parking" class="block text-sm font-medium text-gray-700 mb-2">Parking at
                            origin?</label>
                        <select id="origin-parking" name="origin_parking"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                            <option value="">Select Option</option>
                            <option value="available">Parking available</option>
                            <option value="no-holds">No-holds zone needed</option>
                            <option value="no-info">No information</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Destination Details</h3>
                    <label for="destination-postcode" class="block text-sm font-medium text-gray-700 mb-2">Which city
                        are you moving to?</label>
                    <input type="text" id="destination-postcode" name="destination_postcode"
                        placeholder="Postcode of destination"
                        class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors mb-4">
                    <input type="text" id="destination-city" name="destination_city" placeholder="Name of the city"
                        class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="destination-floor" class="block text-sm font-medium text-gray-700 mb-2">Move-in
                            floor</label>
                        <select id="destination-floor" name="destination_floor"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                            <option value="">Select Floor</option>
                            <option value="1">Floor 1</option>
                            <option value="2">Floor 2</option>
                            <option value="3">Floor 3</option>
                            <option value="4">Floor 4</option>
                            <option value="5+">Floor 5+</option>
                        </select>
                    </div>
                    <div>
                        <label for="destination-elevator" class="block text-sm font-medium text-gray-700 mb-2">Elevator
                            at destination?</label>
                        <select id="destination-elevator" name="destination_elevator"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                            <option value="">Select Option</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    <div>
                        <label for="destination-parking" class="block text-sm font-medium text-gray-700 mb-2">Parking at
                            destination?</label>
                        <select id="destination-parking" name="destination_parking"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                            <option value="">Select Option</option>
                            <option value="available">Parking available</option>
                            <option value="no-holds">No-holds zone needed</option>
                            <option value="no-info">No information</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 4: Time, photos, other info -->
            <div id="step-4" class="step-content">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-800">Additional Information</h2>

                <h3 class="text-lg font-semibold mb-3 text-gray-800">When should the work be done? (optional)</h3>
                <div id="timing-selection" class="flex flex-wrap gap-4 mb-8">
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Urgent">
                        <span class="text-3xl mb-2">‚è∞</span>
                        <span class="text-sm font-medium text-gray-700 text-center">Urgent</span>
                    </div>
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="Consultation">
                        <span class="text-3xl mb-2">ü§ù</span>
                        <span class="text-sm font-medium text-gray-700 text-center">After consultation</span>
                    </div>
                    <div class="icon-card icon-card-small flex-1 flex flex-col items-center p-4 rounded-xl hover:bg-gray-50"
                        data-value="2Weeks">
                        <span class="text-3xl mb-2">üìÖ</span>
                        <span class="text-sm font-medium text-gray-700 text-center">Within 2 weeks</span>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="photos" class="block text-sm font-medium text-gray-700 mb-2">Photos or blueprints
                        (optional)</label>
                    <p class="text-xs text-gray-500 mb-3">By adding images, craftsmen can better assess your order and
                        provide a better deal.</p>
                    <input type="file" id="photos" name="photos" accept="image/*"
                        class="w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                </div>

                <div>
                    <label for="other-info" class="block text-sm font-medium text-gray-700 mb-2">Other information
                        (optional)</label>
                    <p class="text-xs text-gray-500 mb-3">Avoid providing contact details and use the contact functions
                        instead.</p>
                    <textarea id="other-info" name="other_info" rows="4" placeholder="Enter any other details here..."
                        class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"></textarea>
                </div>
            </div>

            <!-- Step 5: Contact Info & Summary -->
            <div id="step-5" class="step-content">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-800">Final Details & Submission</h2>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Get a response from craftsmen in your area.
                    </h3>
                    <p class="text-sm text-gray-500 mb-2">Your data is only visible to craftsmen when you contact them.
                    </p>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="email" name="_replyto" placeholder="youremail@example.com"
                        class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">To get updates on your order, create a customer
                        account.</h3>
                    <p class="text-sm text-gray-500 mb-2">Your data is only visible to craftsmen when you contact them.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="name" name="name" placeholder="Your Full Name"
                                class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                            <input type="tel" id="phone" name="phone_number" placeholder="Phone Number"
                                class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-6 rounded-2xl mb-6">
                    <h4 class="font-bold text-gray-800 mb-2">Summary of your order:</h4>
                    <p id="summary-content" class="text-sm text-gray-700 whitespace-pre-line"></p>
                </div>

                <div class="flex items-center mb-4">
                    <input type="checkbox" id="newsletter-consent"
                        class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                    <label for="newsletter-consent" class="ml-2 block text-xs text-gray-600">
                        I would like to receive advertising about services provided by MyHammer by email, text message
                        and/or telephone. I can unsubscribe at any time.
                    </label>
                </div>
                <p class="text-xs text-gray-500 leading-tight">By clicking on "Next" you are voting Terms and Conditions
                    from MyHammer to.Information on the processing of your data in our Privacy Policy.</p>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between mt-8">
                <button type="button" id="back-button" class="btn-secondary" style="display: none;">Back</button>
                <button type="button" id="next-button"
                    class="ml-auto btn-primary disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
            </div>
        </form>
        <div id="thank-you-message" class="hidden text-center p-10">
            <h2 class="text-3xl font-bold text-green-600 mb-4">Thank you for your order!</h2>
            <p class="text-lg text-gray-700">We have received your information and a craftsman will be in touch shortly.
            </p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('moving-form');
            const stepElements = Array.from(document.querySelectorAll('.step-content'));
            const nextButton = document.getElementById('next-button');
            const backButton = document.getElementById('back-button');
            const progressBar = document.getElementById('progress-bar');
            const stepCount = document.getElementById('step-count');
            const stepName = document.getElementById('step-name');
            const summaryContent = document.getElementById('summary-content');
            const thankYouMessage = document.getElementById('thank-you-message');
            const validationMessage = document.getElementById('validation-message');

            let currentStep = 0;
            const formNames = ["Location", "Transport Details", "Origin & Destination", "Additional Info", "Summary"];

            // Load saved state from localStorage
            let formData = JSON.parse(localStorage.getItem('movingFormData')) || {};

            function saveStepData(stepIndex) {
                switch (stepIndex) {
                    case 0:
                        formData.originPostcode = document.getElementById('origin-postcode').value;
                        break;
                    case 1:
                        formData.itemsToTransport = Array.from(document.querySelectorAll('#item-selection .selected')).map(el => el.dataset.value);
                        formData.boxes = document.getElementById('boxes').value;
                        formData.livingSpace = document.getElementById('living-space').value;
                        formData.packingOption = document.querySelector('#packing-selection .selected')?.dataset.value || null;
                        formData.additionalServices = Array.from(document.querySelectorAll('#services-selection .selected')).map(el => el.dataset.value);
                        break;
                    case 2:
                        formData.origin = {
                            floor: document.getElementById('origin-floor').value,
                            elevator: document.getElementById('origin-elevator').value,
                            parking: document.getElementById('origin-parking').value,
                        };
                        formData.destination = {
                            postcode: document.getElementById('destination-postcode').value,
                            city: document.getElementById('destination-city').value,
                            floor: document.getElementById('destination-floor').value,
                            elevator: document.getElementById('destination-elevator').value,
                            parking: document.getElementById('destination-parking').value,
                        };
                        break;
                    case 3:
                        formData.timing = document.querySelector('#timing-selection .selected')?.dataset.value || null;
                        const photoInput = document.getElementById('photos');
                        if (photoInput.files.length > 0) {
                            formData.photos = { fileName: photoInput.files[0].name, size: photoInput.files[0].size };
                        } else {
                            delete formData.photos;
                        }
                        formData.otherInfo = document.getElementById('other-info').value;
                        break;
                    case 4:
                        formData.email = document.getElementById('email').value;
                        formData.name = document.getElementById('name').value;
                        formData.phone = document.getElementById('phone').value;
                        formData.newsletterConsent = document.getElementById('newsletter-consent').checked;
                        break;
                }
                localStorage.setItem('movingFormData', JSON.stringify(formData));
            }

            function validateStep(stepIndex) {
                switch (stepIndex) {
                    case 0:
                        return document.getElementById('origin-postcode').value.trim() !== '';
                    case 1:
                        return (
                            Array.from(document.querySelectorAll('#item-selection .selected')).length > 0 &&
                            document.querySelector('#packing-selection .selected') !== null
                        );
                    case 2:
                        return (
                            document.getElementById('origin-floor').value !== '' &&
                            document.getElementById('origin-elevator').value !== '' &&
                            document.getElementById('origin-parking').value !== '' &&
                            document.getElementById('destination-postcode').value.trim() !== '' &&
                            document.getElementById('destination-city').value.trim() !== '' &&
                            document.getElementById('destination-floor').value !== '' &&
                            document.getElementById('destination-elevator').value !== '' &&
                            document.getElementById('destination-parking').value !== ''
                        );
                    case 3:
                        // Step 4 has no required fields
                        return true;
                    case 4:
                        const email = document.getElementById('email').value.trim();
                        const name = document.getElementById('name').value.trim();
                        const phone = document.getElementById('phone').value.trim();
                        const newsletterConsent = document.getElementById('newsletter-consent').checked;
                        const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

                        // All contact fields are required for this step
                        return emailValid && name !== '' && phone !== '' && newsletterConsent;
                    default:
                        return true;
                }
            }

            function updateButtonState() {
                const isValid = validateStep(currentStep);
                nextButton.disabled = !isValid;
                validationMessage.classList.toggle('hidden', isValid);

                // Also update submit button if it's the last step
                if (currentStep === stepElements.length - 1) {
                    const nameInput = document.getElementById('name');
                    const phoneInput = document.getElementById('phone');
                    const emailInput = document.getElementById('email');
                    const consentCheckbox = document.getElementById('newsletter-consent');
                    const isFinalStepValid = nameInput.value.trim() !== '' && phoneInput.value.trim() !== '' && emailInput.value.trim() !== '' && consentCheckbox.checked;
                    nextButton.disabled = !isFinalStepValid;
                }
            }

            function updateUI() {
                stepElements.forEach((step, index) => {
                    step.classList.toggle('active', index === currentStep);
                });

                backButton.style.display = currentStep > 0 ? 'block' : 'none';

                if (currentStep === stepElements.length - 1) {
                    nextButton.textContent = 'Submit';
                } else {
                    nextButton.textContent = 'Next';
                }

                const progress = ((currentStep + 1) / stepElements.length) * 100;
                progressBar.style.width = `${progress}%`;
                stepCount.textContent = `Step ${currentStep + 1} of ${stepElements.length}`;
                stepName.textContent = formNames[currentStep];

                if (currentStep === stepElements.length - 1) {
                    generateSummary();
                }

                // Update button state based on validation
                updateButtonState();
            }

            function generateSummary() {
                let summaryText = "";
                const data = formData;
                for (const key in data) {
                    let value = data[key];
                    if (Array.isArray(value) && value.length > 0) {
                        value = value.join(', ');
                    } else if (typeof value === 'object' && value !== null) {
                        // Check for file data
                        if (value.fileName) {
                            summaryText += `\n<strong>${key}:</strong> ${value.fileName}`;
                            continue;
                        }
                        // Handle nested objects from form fields
                        let nestedSummary = [];
                        for (const subKey in value) {
                            if (value[subKey]) {
                                nestedSummary.push(`${subKey}: ${value[subKey]}`);
                            }
                        }
                        if (nestedSummary.length > 0) {
                            summaryText += `\n<strong>${key}:</strong>\n - ${nestedSummary.join('\n - ')}`;
                        }
                        continue;
                    }
                    if (value) {
                        summaryText += `\n<strong>${key}:</strong> ${value}`;
                    }
                }
                summaryContent.innerHTML = summaryText.trim() === "" ? "No data entered yet." : summaryText;
            }

            function handleStepChange(direction) {
                // Save data for the current step
                saveStepData(currentStep);

                const nextStep = currentStep + direction;
                if (nextStep >= 0 && nextStep < stepElements.length) {
                    currentStep = nextStep;
                    updateUI();
                }
            }

            async function handleSubmit(event) {
                event.preventDefault();
                saveStepData(currentStep);

                // Collect all form data including hidden fields
                const formInputs = document.querySelectorAll('input, select, textarea');
                const submitData = {};
                formInputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        submitData[input.name] = input.checked;
                    } else if (input.type === 'file') {
                        if (input.files.length > 0) {
                            submitData[input.name] = input.files[0].name; // Just send the file name for simplicity
                        }
                    } else if (input.name) {
                        submitData[input.name] = input.value;
                    }
                });

                // Add selected icon values to the submission data
                const itemSelection = Array.from(document.querySelectorAll('#item-selection .selected')).map(el => el.dataset.value);
                if (itemSelection.length > 0) {
                    submitData['items_to_transport'] = itemSelection.join(', ');
                }

                const packingOption = document.querySelector('#packing-selection .selected')?.dataset.value;
                if (packingOption) {
                    submitData['packing_option'] = packingOption;
                }

                const additionalServices = Array.from(document.querySelectorAll('#services-selection .selected')).map(el => el.dataset.value);
                if (additionalServices.length > 0) {
                    submitData['additional_services'] = additionalServices.join(', ');
                }

                const timingOption = document.querySelector('#timing-selection .selected')?.dataset.value;
                if (timingOption) {
                    submitData['timing_option'] = timingOption;
                }

                // Check honeypot field
                if (form.querySelector('input[name="_honeypot"]').value !== '') {
                    console.log('Bot detected, form submission blocked.');
                    return; // Silently block bot submissions
                }

                try {
                    // Replace with your actual serverless function URL
                    const response = await fetch('/api/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(submitData),
                    });

                    if (response.ok) {
                        console.log('Form submitted successfully!');
                        localStorage.removeItem('movingFormData');
                        form.classList.add('hidden');
                        thankYouMessage.classList.remove('hidden');
                    } else {
                        console.error('Submission failed:', response.statusText);
                        // Display error message to user
                        validationMessage.textContent = 'Submission failed. Please try again later.';
                        validationMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    validationMessage.textContent = 'Network error. Please check your connection and try again.';
                    validationMessage.classList.remove('hidden');
                }
            }

            // Move event listeners to a helper function that will be called after the functions are defined.
            function setupEventListeners() {
                nextButton.addEventListener('click', (event) => {
                    if (currentStep === stepElements.length - 1) {
                        handleSubmit(event);
                    } else if (validateStep(currentStep)) {
                        handleStepChange(1);
                    } else {
                        validationMessage.classList.remove('hidden');
                    }
                });

                backButton.addEventListener('click', () => {
                    validationMessage.classList.add('hidden');
                    handleStepChange(-1);
                });

                form.addEventListener('change', updateButtonState);
                form.addEventListener('input', updateButtonState);

                // Handle icon selections for single-select groups
                function setupSingleSelect(containerId) {
                    document.getElementById(containerId).addEventListener('click', (event) => {
                        const card = event.target.closest('.icon-card');
                        if (card) {
                            Array.from(card.parentNode.children).forEach(child => child.classList.remove('selected'));
                            card.classList.add('selected');
                            updateButtonState();
                        }
                    });
                }

                // Handle icon selections for multi-select groups
                function setupMultiSelect(containerId) {
                    document.getElementById(containerId).addEventListener('click', (event) => {
                        const card = event.target.closest('.icon-card');
                        if (card) {
                            card.classList.toggle('selected');
                            updateButtonState();
                        }
                    });
                }

                setupMultiSelect('item-selection');
                setupSingleSelect('packing-selection');
                setupMultiSelect('services-selection');
                setupSingleSelect('timing-selection');
            }

            // Initial UI update and event listener setup
            updateUI();
            setupEventListeners();
        });
    </script>
</body>

</html>